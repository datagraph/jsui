<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Dydra.com — Sign Up" />
    <meta name="author" content="Dydra" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up — Dydra</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="stylesheet" href="./stylesheets/style.css" media="screen" />
    <link rel="stylesheet" href="./stylesheets/jsui-overrides.css" media="screen" />
  </head>
  <body class="devise registrations new">
    <div id="header">
      <div class="wrapper">
        <a href="/" id="logo">Dydra</a>
        <div id="nav">
          <ul class="nav">
            <li><a href="http://docs.dydra.com/dydra">About</a></li>
            <li><a href="http://docs.dydra.com">Documentation</a></li>
            <li><a href="http://blog.dydra.com">Blog</a></li>
            <li><a href="/login">Login</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="main">
      <div id="main-0">
        <div class="wrapper">
          <div id="content">
            <h1 id="content-title">Get Started with Dydra</h1>
            <div id="error-messages" class="widget" style="display:none;">
              <div class="alert-error rounded">
                <p class="message">
                  <span class="icon icon-alert"></span>
                  <span id="error-text"></span>
                </p>
              </div>
            </div>
            <div id="success-message" class="widget" style="display:none;">
              <div class="alert-success rounded" style="padding:8px;">
                <p class="message">
                  <span id="success-text"></span>
                </p>
              </div>
            </div>
            <form id="signup-form" class="formtastic" action="/signup" method="post">
              <fieldset class="inputs">
                <ol>
                  <li id="invite-code-field" class="string optional">
                    <label for="account_invite_code">Invite code</label>
                    <input type="text" id="account_invite_code" name="account[invite_code]" />
                  </li>
                  <li class="string optional">
                    <label for="account_name">Username</label>
                    <input type="text" id="account_name" name="account[name]" required />
                  </li>
                  <li class="email optional">
                    <label for="account_email">Email</label>
                    <input type="email" id="account_email" name="account[email]" required />
                  </li>
                  <li class="password optional">
                    <label for="account_password">Password</label>
                    <input type="password" id="account_password" name="account[password]" required />
                  </li>
                  <li class="password optional">
                    <label for="account_password_confirmation">Confirm Password</label>
                    <input type="password" id="account_password_confirmation" name="account[password_confirmation]" required />
                  </li>
                </ol>
              </fieldset>
              <fieldset class="buttons">
                <ol>
                  <li class="commit"><input type="submit" value="Sign up" /></li>
                </ol>
              </fieldset>
            </form>
          </div>
          <div id="aside">
            <a class="login" id="aside-link" href="/login">Already have an account? <strong>Log in</strong></a>
            <h5>Don't have an invite code?</h5>
            <p>Dydra is currently in closed beta and only accepting signups using invite codes.</p>
            <form id="join-beta" action="/invitations" method="post">
              <h3>Request an invite</h3>
              <p>Enter your email address and we'll<br />let you know when a slot is available.</p>
              <p class="textfield">
                <input id="invitation_email" name="invitation[email]" type="text" placeholder="Your email address..." />
                <a class="disabled submit" href="#" id="notify-btn">Notify Me</a>
              </p>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div id="footer">
      <div class="wrapper">
        <p id="copyright">
          A product of <a href="http://datagraph.org/">Datagraph, Inc.</a>
          &nbsp;&bull;&nbsp;<span><a href="http://docs.dydra.com/dydra">About</a></span>
          &nbsp;&bull;&nbsp;<span><a href="http://docs.dydra.com">Documentation</a></span>
          &nbsp;&bull;&nbsp;<span><a href="http://blog.dydra.com">Blog</a></span>
          &nbsp;&bull;&nbsp;<span><a href="/legal">Legal</a></span>
        </p>
        <p id="footer-links">
          <a href="https://github.com/dydra/support/blob/master/README.rst#readme">Support</a>
          &nbsp;&bull;&nbsp;
          <a href="https://github.com/dydra">GitHub</a>
          &nbsp;&bull;&nbsp;
          <a href="http://twitter.com/dydradata">Twitter</a>
          &nbsp;&bull;&nbsp;
          <a href="http://feeds.feedburner.com/dydra">RSS</a>
        </p>
      </div>
    </div>
    <script>
      // Pre-fill invite code from URL parameter
      (function () {
        var params = new URLSearchParams(window.location.search);
        var code = params.get("invite_code");
        if (code) {
          var field = document.getElementById("account_invite_code");
          if (field) field.value = code;
        }
      })();

      document.getElementById("signup-form").addEventListener("submit", async function (e) {
        e.preventDefault();
        var form = this;
        var errorBox = document.getElementById("error-messages");
        var errorText = document.getElementById("error-text");
        var successBox = document.getElementById("success-message");
        var successText = document.getElementById("success-text");
        errorBox.style.display = "none";
        successBox.style.display = "none";

        var body = new URLSearchParams(new FormData(form)).toString();

        try {
          var response = await fetch(form.action, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded", "Accept": "text/html" },
            body: body,
          });

          if (response.ok || response.status === 302 || response.status === 303) {
            successBox.style.display = "block";
            successText.textContent = "Your account has been created. Check your email for confirmation instructions.";
            form.style.display = "none";
          } else {
            var text = "";
            try { text = await response.text(); } catch (_) {}
            errorBox.style.display = "block";
            errorText.textContent = text || "Registration failed. Please check your details and try again.";
          }
        } catch (err) {
          errorBox.style.display = "block";
          errorText.textContent = "Could not reach the server. Please try again later.";
        }
      });

      // Enable the "Notify Me" button when email is entered
      var notifyBtn = document.getElementById("notify-btn");
      var inviteEmail = document.getElementById("invitation_email");
      if (notifyBtn && inviteEmail) {
        inviteEmail.addEventListener("input", function () {
          if (this.value && this.value !== "Your email address...") {
            notifyBtn.classList.remove("disabled");
          } else {
            notifyBtn.classList.add("disabled");
          }
        });
        notifyBtn.addEventListener("click", async function (e) {
          e.preventDefault();
          if (notifyBtn.classList.contains("disabled")) return;
          var email = inviteEmail.value;
          if (!email) return;
          try {
            await fetch("/invitations", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: "invitation%5Bemail%5D=" + encodeURIComponent(email),
            });
            inviteEmail.value = "";
            notifyBtn.classList.add("disabled");
            inviteEmail.placeholder = "Request sent!";
          } catch (_) {}
        });
      }
    </script>
  </body>
</html>
